<!doctype html>
<html lang="en">
<!-- Mobile compact pass: row height/padding tweaked for ~36-40px rows on <=480px; adjust in style.css @media (max-width:480px) and .handicap-display/.handicap-card-body spacing. -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golfer Handicaps</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link href="/style.css" rel="stylesheet">
</head>
<body style="background:linear-gradient(180deg,#0b1827 0%,#0f243a 100%);color:#e5f0ff;">
  <header class="bar" style="position:sticky;top:0;z-index:5;">
    <h1 class="title">Golfer Handicaps</h1>
    <nav style="display:flex;gap:10px;align-items:center;margin-left:auto">
      <a href="/" class="handicap-link">Back to Tee Times</a>
    </nav>
  </header>

  <main class="handicap-container">
    <div class="handicap-header">
      <div>
        <p style="margin:0;color:#9fb6d4;font-size:13px;">Track the latest handicaps for the group</p>
      </div>
      <button id="addGolferBtn" class="primary">Add Golfer</button>
    </div>

    <div id="statusMsg" class="muted" style="margin-bottom:10px;font-size:13px;"></div>
    <div id="handicapGrid" class="handicap-grid"></div>
  </main>

  <dialog id="golferDialog" style="border:none;border-radius:12px;max-width:420px;padding:0;box-shadow:0 20px 40px rgba(0,0,0,0.35);">
    <form id="golferForm" method="dialog" style="padding:18px;display:grid;gap:12px;">
      <h3 style="margin:0;font-size:18px;">Golfer</h3>
      <label style="display:grid;gap:6px;font-size:14px;">
        Name
        <input name="name" required placeholder="Full name">
      </label>
      <label style="display:grid;gap:6px;font-size:14px;">
        Club
        <input name="clubName" placeholder="Club name" required>
      </label>
      <label style="display:grid;gap:6px;font-size:14px;">
        Handicap Index
        <input name="handicapIndex" type="number" step="0.1" min="-5" max="60" placeholder="e.g., 12.4" required>
      </label>
      <label style="display:grid;gap:6px;font-size:14px;">
        Personal Admin Code
        <input name="ownerCode" type="password" placeholder="Required to edit your entry">
      </label>
      <label style="display:grid;gap:6px;font-size:14px;">
        Site Admin Code (optional override)
        <input name="adminCode" type="password" placeholder="Admin override">
      </label>
      <input type="hidden" name="id">
      <menu style="display:flex;justify-content:flex-end;gap:8px;margin:0;">
        <button type="button" data-cancel>Cancel</button>
        <button type="submit" class="primary">Save</button>
      </menu>
    </form>
  </dialog>

  
  <script>
    const grid = document.getElementById('handicapGrid');
    const statusMsg = document.getElementById('statusMsg');
    const addBtn = document.getElementById('addGolferBtn');
    const dlg = document.getElementById('golferDialog');
    const form = document.getElementById('golferForm');
    const adminField = form?.elements?.adminCode;

    function fmtDate(val) {
      if (!val) return '';
      const d = new Date(val);
      if (isNaN(d)) return '';
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function setStatus(text, color = '#9fb6d4') {
      if (!statusMsg) return;
      statusMsg.textContent = text || '';
      statusMsg.style.color = color;
    }

    async function api(path, opts = {}) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) }, ...opts });
      const isJson = (res.headers.get('content-type') || '').includes('application/json');
      const body = isJson ? await res.json() : await res.text();
      if (!res.ok) {
        const msg = body && body.error ? body.error : (body && body.message) ? body.message : res.statusText;
        throw new Error(msg || 'Request failed');
      }
      return body;
    }

    function openDialog(data = null) {
      form.reset();
      form.elements.id.value = data?._id || '';
      form.elements.name.value = data?.name || '';
      form.elements.clubName.value = data?.clubName || '';
      form.elements.handicapIndex.value = data?.handicapIndex ?? '';
      const savedAdmin = localStorage.getItem('handicapAdminCode');
      if (savedAdmin) form.elements.adminCode.value = savedAdmin;
      dlg.showModal();
    }

    async function loadHandicaps() {
      document.body.classList.add('compact-mode'); // enable compact styling (mobile-first toggle)
      setStatus('Loading.');
      try {
        const list = await api('/api/handicaps');
        render(list || []);
        setStatus(`Loaded ${list.length} golfers`);
      } catch (e) {
        console.error(e);
        setStatus('Failed to load handicaps: ' + e.message, '#ef4444');
      }
    }

    function render(list) {
      grid.innerHTML = '';
      if (!list.length) {
        grid.innerHTML = '<div class="handicap-card" style="grid-column:1/-1;text-align:center;color:#9fb6d4;">No golfers yet.</div>';
        return;
      }
      for (const h of list) {
        const card = document.createElement('div');
        card.className = 'handicap-card';
        const hcp = (h.handicapIndex === 0 || h.handicapIndex) ? Number(h.handicapIndex).toFixed(1) : 'N/A';
        const detailsId = `details-${h._id}`;
        card.innerHTML = `
          <div class="handicap-card-header">
            <div>
              <div class="handicap-name">${h.name || 'Unknown'}</div>
              ${h.clubName ? `<div class="handicap-meta">${h.clubName}</div>` : ''}
            </div>
            <div class="handicap-actions">
              <button class="small icon-btn" data-edit="${h._id}" aria-label="Edit ${h.name || 'golfer'}">‚úèÔ∏è</button>
              <button class="small icon-btn danger" data-del="${h._id}" aria-label="Delete ${h.name || 'golfer'}">üóëÔ∏è</button>
              <button class="small icon-btn secondary" data-expand="${detailsId}" aria-expanded="false" aria-controls="${detailsId}" title="Details">‚ãØ</button>
            </div>
          </div>
          <div class="handicap-card-body">
            <div class="handicap-display">
              <div class="handicap-index">${hcp}</div>
              <div class="handicap-label">Handicap Index</div>
            </div>
            ${h.updatedAt ? `<div class="handicap-meta">Updated ${fmtDate(h.updatedAt)}</div>` : ''}
          </div>
          <div id="${detailsId}" class="handicap-extra" hidden>
            ${h.ghinNumber ? `<div class="handicap-meta">GHIN: ${h.ghinNumber}</div>` : ''}
            <div class="handicap-meta">Use your personal code to edit. Admin override allowed.</div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    addBtn?.addEventListener('click', () => openDialog());

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const data = Object.fromEntries(new FormData(form).entries());
        const name = (data.name || '').trim();
        if (!name) {
          alert('Name is required.');
          return;
        }
        const ownerCode = (data.ownerCode || '').trim();
        const admin = (data.adminCode || '').trim();
        if (!ownerCode && !admin) return alert('Personal code required to save (or admin override).');
        if (admin) localStorage.setItem('handicapAdminCode', admin);
        const payload = {
          name,
          ghinNumber: data.ghinNumber || undefined,
          handicapIndex: data.handicapIndex === '' ? null : Number(data.handicapIndex),
          notes: data.notes || '',
          ownerCode: ownerCode || undefined
        };
        const id = data.id;
        const headers = admin ? { 'x-admin-code': admin } : {};
        if (id) {
          await api(`/api/handicaps/${id}`, { method: 'PUT', body: JSON.stringify(payload), headers });
        } else {
          await api('/api/handicaps', { method: 'POST', body: JSON.stringify(payload), headers });
        }
        dlg.close();
        loadHandicaps();
      } catch (err) {
        console.error(err);
        alert('Save failed: ' + err.message);
      }
    });

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-edit],[data-del],[data-cancel],[data-expand]');
      if (!btn) return;
      if (btn.dataset.cancel !== undefined) {
        dlg.close();
        return;
      }
      if (btn.dataset.expand) {
        const section = document.getElementById(btn.dataset.expand);
        if (section) {
          const isHidden = section.hasAttribute('hidden');
          if (isHidden) section.removeAttribute('hidden'); else section.setAttribute('hidden', '');
          btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        }
        return;
      }
      if (btn.dataset.edit) {
        const id = btn.dataset.edit;
        const currentCard = btn.closest('.handicap-card');
        const name = currentCard?.querySelector('.handicap-name')?.textContent || '';
        const ghin = currentCard?.querySelector('.handicap-extra .handicap-meta')?.textContent?.replace('GHIN: ','') || '';
        const hcpText = currentCard?.querySelector('.handicap-index')?.textContent || '';
        const notesEl = currentCard?.querySelectorAll('.handicap-meta')?.[1];
        openDialog({
          _id: id,
          name,
          ghinNumber: ghin || '',
          handicapIndex: hcpText && hcpText !== 'N/A' ? Number(hcpText) : '',
          notes: notesEl ? notesEl.textContent : ''
        });
        return;
      }
      if (btn.dataset.del) {
        const id = btn.dataset.del;
        if (!confirm('Delete this golfer?')) return;
        const admin = localStorage.getItem('handicapAdminCode') || '';
        const ownerCode = prompt('Enter your personal code (or admin code):') || '';
        try {
          const headers = {};
          if (admin) headers['x-admin-code'] = admin;
          await api(`/api/handicaps/${id}?ownerCode=${encodeURIComponent(ownerCode)}`, { method: 'DELETE', headers });
          loadHandicaps();
        } catch (err) {
          console.error(err);
          alert('Delete failed: ' + err.message);
        }
      }
    });

    dlg?.addEventListener('click', (e) => {
      if (e.target.dataset.cancel !== undefined) {
        dlg.close();
      }
    });

    loadHandicaps();
  </script>

</body>
</html>

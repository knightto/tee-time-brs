<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valley Sip and Smoke</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    :root {
      --bg: #120d0a;
      --panel: #1d1511;
      --panel-soft: #2a2019;
      --accent: #cf8b38;
      --accent-soft: #f3d5a6;
      --ink: #f9eee0;
      --ink-soft: #cab59b;
      --border: rgba(255, 255, 255, 0.1);
      --ok: #8bcf7a;
      --warn: #d9a35e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 10%, rgba(207,139,56,0.18), transparent 33%),
        radial-gradient(circle at 80% 0%, rgba(140,95,52,0.2), transparent 30%),
        linear-gradient(180deg, #17100d 0%, var(--bg) 55%, #0f0907 100%);
      min-height: 100vh;
    }
    .shell {
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 14px 36px;
    }
    .top {
      position: sticky;
      top: 0;
      z-index: 6;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(140deg, #241912 0%, #1b130f 100%);
      padding: 14px;
      display: grid;
      gap: 10px;
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(8px);
    }
    .top h1 {
      margin: 0;
      font-size: clamp(1.3rem, 3vw, 1.9rem);
      letter-spacing: 0.2px;
    }
    .top small { color: var(--ink-soft); }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--ink-soft);
      font-size: 0.82rem;
      background: rgba(255, 255, 255, 0.04);
    }
    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 12px;
    }
    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(145deg, var(--panel) 0%, #1a130f 100%);
      padding: 14px;
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.28);
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      color: var(--accent-soft);
      letter-spacing: 0.2px;
    }
    .facts {
      display: grid;
      gap: 6px;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .facts strong { color: #fff; }
    .plans {
      display: grid;
      gap: 8px;
    }
    .plan {
      background: var(--panel-soft);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
    }
    .plan-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }
    .price { color: var(--accent-soft); }
    .list {
      margin: 0;
      padding-left: 18px;
      color: var(--ink-soft);
      line-height: 1.5;
      font-size: 0.92rem;
    }
    .calendar {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }
    .calendar li {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    .muted { color: var(--ink-soft); font-size: 0.86rem; }
    .status {
      font-size: 0.78rem;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      color: #14100d;
      background: var(--ok);
      font-weight: 700;
      white-space: nowrap;
    }
    .status.wait { background: var(--warn); }
    .cta {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      text-decoration: none;
      font-weight: 700;
      border-radius: 10px;
      padding: 9px 12px;
      border: 1px solid var(--border);
      color: var(--ink);
      background: #2c221b;
    }
    .btn.primary {
      color: #1a130e;
      background: linear-gradient(160deg, #f2cf96 0%, #cf8b38 100%);
      border-color: rgba(242, 207, 150, 0.5);
    }
    input, select, textarea, button {
      font: inherit;
    }
    .field {
      display: grid;
      gap: 5px;
      margin-bottom: 8px;
    }
    .field input, .field select, .field textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #140f0c;
      color: var(--ink);
    }
    .tools {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .tool-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: linear-gradient(145deg, #201711 0%, #1a120e 100%);
      padding: 12px;
    }
    .tool-card h3 {
      margin: 0 0 8px;
      color: var(--accent-soft);
      font-size: 0.95rem;
    }
    .tool-card p {
      margin: 0 0 8px;
      color: var(--ink-soft);
      font-size: 0.85rem;
    }
    .tool-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .msg {
      margin-top: 8px;
      font-size: 0.82rem;
      color: var(--accent-soft);
      min-height: 1.1em;
    }
    .table-wrap {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }
    .tiny {
      padding: 5px 8px;
      border-radius: 7px;
      border: 1px solid var(--border);
      background: #2d241d;
      color: var(--ink);
      cursor: pointer;
      font-weight: 700;
      font-size: 0.77rem;
    }
    .tiny.primary {
      background: linear-gradient(160deg, #f2cf96 0%, #cf8b38 100%);
      color: #1a130e;
    }
    @media (max-width: 880px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="top">
      <a href="/" class="btn" style="width:max-content;">Back to Tee Times</a>
      <h1>Valley Sip and Smoke</h1>
      <small>The Knight Club Lounge at On Cue - Front Royal, VA</small>
      <div class="row">
        <span class="chip">Bourbon + cigar nights</span>
        <span class="chip">Member and locker plans</span>
        <span class="chip">Thursday and Sunday schedule</span>
      </div>
    </header>

    <section class="grid">
      <article class="panel">
        <h2>Event Overview</h2>
        <div class="facts">
          <div><strong>Venue:</strong> The Knight Club Lounge at On Cue</div>
          <div><strong>City:</strong> Front Royal, Virginia</div>
          <div><strong>Format:</strong> Social bourbon and cigar sessions with reserve bottle access.</div>
          <div><strong>Host flow:</strong> Member sign-in, check-in, reserve bottle selection, and event roster.</div>
        </div>
        <div class="cta">
          <a class="btn primary" href="mailto:tommy.knight@gmail.com?subject=Valley%20Sip%20and%20Smoke%20Membership">Request Membership</a>
          <a class="btn" href="mailto:tommy.knight@gmail.com?subject=Valley%20Sip%20and%20Smoke%20Question">Ask a Question</a>
        </div>
      </article>

      <article class="panel">
        <h2>Membership Plans</h2>
        <div class="plans">
          <div class="plan">
            <div class="plan-head"><span>Member</span><span class="price">$65 / month</span></div>
            <ul class="list">
              <li>Access to all scheduled sip and smoke nights</li>
              <li>Event RSVP and member check-in participation</li>
              <li>Shared reserve bottle purchase windows</li>
            </ul>
          </div>
          <div class="plan">
            <div class="plan-head"><span>Locker Member</span><span class="price">$95 / month</span></div>
            <ul class="list">
              <li>All member benefits</li>
              <li>Personal locker storage at the venue</li>
              <li>Priority access on reserve releases</li>
            </ul>
          </div>
        </div>
      </article>
    </section>

    <section class="grid">
      <article class="panel">
        <h2>Upcoming Nights</h2>
        <ul class="calendar" id="scheduleList"></ul>
      </article>
      <article class="panel">
        <h2>Operations Notes</h2>
        <ul class="list">
          <li>Doors open at 6:30 PM for Thursday sessions.</li>
          <li>Sunday sessions are hosted as relaxed tasting blocks.</li>
          <li>Check-in desk confirms member passcode access.</li>
          <li>Admin review covers RSVP list, reserve inventory, and attendance export.</li>
        </ul>
        <p class="muted" style="margin-top:10px;">This is now a first-class page in the main Tee Time site, matching the Myrtle trip style and deployment model.</p>
      </article>
    </section>

    <section class="tools">
      <article class="tool-card">
        <h3>Member Sign-In + RSVP</h3>
        <p>Members can sign in and RSVP for a specific event night.</p>
        <form id="memberForm">
          <label class="field">
            <span>Name</span>
            <input id="memberNameInput" type="text" required placeholder="Your name">
          </label>
          <label class="field">
            <span>Member Passcode</span>
            <input id="memberPasscodeInput" type="password" required placeholder="Passcode">
          </label>
          <label class="field">
            <span>Event Night</span>
            <select id="eventSelect" required></select>
          </label>
          <div class="tool-actions">
            <button class="tiny primary" type="submit">Sign In + RSVP</button>
          </div>
          <div class="msg" id="memberMsg"></div>
        </form>
      </article>

      <article class="tool-card">
        <h3>Reserve Bottle Selection</h3>
        <p>Submit reserve bottle requests for the host inventory review.</p>
        <form id="reserveForm">
          <label class="field">
            <span>Member Name</span>
            <input id="reserveNameInput" type="text" required placeholder="Member name">
          </label>
          <label class="field">
            <span>Bottle</span>
            <select id="reserveBottleSelect" required>
              <option value="">Select a bottle...</option>
              <option value="Weller Antique 107">Weller Antique 107</option>
              <option value="Blanton's Single Barrel">Blanton's Single Barrel</option>
              <option value="Booker's Bourbon">Booker's Bourbon</option>
              <option value="E.H. Taylor Small Batch">E.H. Taylor Small Batch</option>
              <option value="Host Choice">Host Choice</option>
            </select>
          </label>
          <label class="field">
            <span>Request Notes</span>
            <textarea id="reserveNotesInput" rows="2" placeholder="Optional notes"></textarea>
          </label>
          <div class="tool-actions">
            <button class="tiny primary" type="submit">Submit Request</button>
          </div>
          <div class="msg" id="reserveMsg"></div>
        </form>
      </article>
    </section>

    <section class="grid">
      <article class="panel">
        <h2>Event Roster + Check-In</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Event</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rosterBody"></tbody>
          </table>
        </div>
        <div class="tool-actions">
          <button id="exportRosterBtn" class="tiny">Export Attendance CSV</button>
          <button id="clearRosterBtn" class="tiny">Clear Local Data</button>
        </div>
      </article>

      <article class="panel">
        <h2>Reserve Request Queue</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Member</th>
                <th>Bottle</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="reserveBody"></tbody>
          </table>
        </div>
      </article>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "valleySipSmokeState";
    const MEMBER_PASSCODE = "sipsmoke";

    function nextDatesByWeekday(weekday, count) {
      const out = [];
      const d = new Date();
      while (out.length < count) {
        d.setDate(d.getDate() + 1);
        if (d.getDay() === weekday) out.push(new Date(d));
      }
      return out;
    }

    function fmtDate(d) {
      return d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
    }

    function buildSchedule() {
      const thursdays = nextDatesByWeekday(4, 3).map((d, idx) => ({
        id: `thu-${idx + 1}`,
        date: d,
        label: "Thursday Night Pour",
        state: "Open RSVP",
        hour: 18,
        minute: 30
      }));
      const sundays = nextDatesByWeekday(0, 3).map((d, idx) => ({
        id: `sun-${idx + 1}`,
        date: d,
        label: "Sunday Smoke Session",
        state: "Waitlist",
        hour: 16,
        minute: 0
      }));
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() + 14);
      return thursdays
        .concat(sundays)
        .filter((item) => item.date <= cutoff)
        .sort((a, b) => a.date - b.date);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { attendees: [], reserveRequests: [] };
        const parsed = JSON.parse(raw);
        return {
          attendees: Array.isArray(parsed.attendees) ? parsed.attendees : [],
          reserveRequests: Array.isArray(parsed.reserveRequests) ? parsed.reserveRequests : []
        };
      } catch {
        return { attendees: [], reserveRequests: [] };
      }
    }

    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function escapeHtml(val) {
      return String(val || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function fmtEventLabel(eventId, schedule) {
      const e = schedule.find((x) => x.id === eventId);
      return e ? `${e.label} (${fmtDate(e.date)})` : "Unknown event";
    }

    function toICSDate(d, hour, minute) {
      const x = new Date(d);
      x.setHours(hour, minute, 0, 0);
      const y = x.getUTCFullYear();
      const m = String(x.getUTCMonth() + 1).padStart(2, "0");
      const day = String(x.getUTCDate()).padStart(2, "0");
      const hh = String(x.getUTCHours()).padStart(2, "0");
      const mm = String(x.getUTCMinutes()).padStart(2, "0");
      return `${y}${m}${day}T${hh}${mm}00Z`;
    }

    function downloadEventICS(item) {
      const start = toICSDate(item.date, item.hour, item.minute);
      const end = toICSDate(item.date, item.hour + 2, item.minute);
      const uid = `${item.id}-${Date.now()}@valleysipsmoke`;
      const ics = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Valley Sip and Smoke//EN",
        "BEGIN:VEVENT",
        `UID:${uid}`,
        `DTSTAMP:${toICSDate(new Date(), 0, 0)}`,
        `DTSTART:${start}`,
        `DTEND:${end}`,
        `SUMMARY:${item.label}`,
        "LOCATION:The Knight Club Lounge at On Cue, Front Royal, VA",
        "DESCRIPTION:Valley Sip and Smoke event night",
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");
      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${item.label.replace(/\s+/g, "-").toLowerCase()}.ics`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderEventSelect(schedule) {
      const select = document.getElementById("eventSelect");
      if (!select) return;
      select.innerHTML = schedule.map((item) => `<option value="${item.id}">${item.label} - ${fmtDate(item.date)}</option>`).join("");
    }

    function renderRoster(state, schedule) {
      const body = document.getElementById("rosterBody");
      if (!body) return;
      if (!state.attendees.length) {
        body.innerHTML = `<tr><td colspan="4" class="muted">No members signed in yet.</td></tr>`;
        return;
      }
      body.innerHTML = state.attendees.map((a) => `
        <tr>
          <td>${escapeHtml(a.name)}</td>
          <td>${escapeHtml(fmtEventLabel(a.eventId, schedule))}</td>
          <td>${a.checkedIn ? "Checked In" : "RSVP Only"}</td>
          <td>
            <button class="tiny${a.checkedIn ? "" : " primary"}" data-action="toggle-checkin" data-id="${a.id}">
              ${a.checkedIn ? "Undo Check-In" : "Mark Check-In"}
            </button>
            <button class="tiny" data-action="remove-attendee" data-id="${a.id}">Remove</button>
          </td>
        </tr>
      `).join("");
    }

    function renderReserveQueue(state) {
      const body = document.getElementById("reserveBody");
      if (!body) return;
      if (!state.reserveRequests.length) {
        body.innerHTML = `<tr><td colspan="3" class="muted">No reserve requests submitted.</td></tr>`;
        return;
      }
      body.innerHTML = state.reserveRequests.map((r) => `
        <tr>
          <td>${escapeHtml(r.name)}</td>
          <td>${escapeHtml(r.bottle)}</td>
          <td>${escapeHtml(r.notes || "-")}</td>
        </tr>
      `).join("");
    }

    function exportRoster(state, schedule) {
      if (!state.attendees.length) return;
      const rows = [["name", "event", "status"]].concat(
        state.attendees.map((a) => [
          a.name,
          fmtEventLabel(a.eventId, schedule),
          a.checkedIn ? "checked_in" : "rsvp_only"
        ])
      );
      const csv = rows.map((r) => r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "valley-sip-and-smoke-attendance.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderSchedule() {
      const all = buildSchedule();
      const list = document.getElementById("scheduleList");
      if (!list) return;
      list.innerHTML = all.map((item) => {
        const wait = item.state.toLowerCase().includes("wait");
        return `
          <li>
            <div>
              <div><strong>${item.label}</strong></div>
              <div class="muted">${fmtDate(item.date)}</div>
            </div>
            <div style="display:grid;justify-items:end;gap:6px;">
              <span class="status${wait ? " wait" : ""}">${item.state}</span>
              <div class="tool-actions" style="margin:0;">
                <button class="tiny" data-action="rsvp" data-event-id="${item.id}">RSVP</button>
                <button class="tiny" data-action="ics" data-event-id="${item.id}">Add to Calendar</button>
              </div>
            </div>
          </li>
        `;
      }).join("");
      return all;
    }

    window.addEventListener("DOMContentLoaded", () => {
      const schedule = renderSchedule() || [];
      const state = loadState();
      renderEventSelect(schedule);
      renderRoster(state, schedule);
      renderReserveQueue(state);

      const memberForm = document.getElementById("memberForm");
      const reserveForm = document.getElementById("reserveForm");
      const memberMsg = document.getElementById("memberMsg");
      const reserveMsg = document.getElementById("reserveMsg");
      const eventSelect = document.getElementById("eventSelect");

      const scheduleList = document.getElementById("scheduleList");
      if (scheduleList) {
        scheduleList.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const eventId = btn.dataset.eventId;
          const item = schedule.find((x) => x.id === eventId);
          if (!item) return;
          if (btn.dataset.action === "rsvp") {
            if (eventSelect) eventSelect.value = eventId;
            const nameInput = document.getElementById("memberNameInput");
            if (nameInput) nameInput.focus();
          }
          if (btn.dataset.action === "ics") {
            downloadEventICS(item);
          }
        });
      }

      if (memberForm) {
        memberForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = (document.getElementById("memberNameInput")?.value || "").trim();
          const passcode = (document.getElementById("memberPasscodeInput")?.value || "").trim();
          const eventId = (eventSelect?.value || "").trim();
          if (!name || !eventId) {
            memberMsg.textContent = "Enter your name and choose an event.";
            return;
          }
          if (passcode !== MEMBER_PASSCODE) {
            memberMsg.textContent = "Invalid member passcode.";
            return;
          }
          const exists = state.attendees.some((a) => a.eventId === eventId && a.name.toLowerCase() === name.toLowerCase());
          if (exists) {
            memberMsg.textContent = "You are already RSVP'd for this event.";
            return;
          }
          state.attendees.push({
            id: `a-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
            name,
            eventId,
            checkedIn: false
          });
          saveState(state);
          renderRoster(state, schedule);
          memberForm.reset();
          renderEventSelect(schedule);
          memberMsg.textContent = "Signed in and RSVP saved.";
        });
      }

      if (reserveForm) {
        reserveForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = (document.getElementById("reserveNameInput")?.value || "").trim();
          const bottle = (document.getElementById("reserveBottleSelect")?.value || "").trim();
          const notes = (document.getElementById("reserveNotesInput")?.value || "").trim();
          if (!name || !bottle) {
            reserveMsg.textContent = "Enter name and select a bottle.";
            return;
          }
          state.reserveRequests.push({ name, bottle, notes });
          saveState(state);
          renderReserveQueue(state);
          reserveForm.reset();
          reserveMsg.textContent = "Reserve request submitted.";
        });
      }

      const rosterBody = document.getElementById("rosterBody");
      if (rosterBody) {
        rosterBody.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          if (!id || !action) return;
          if (action === "toggle-checkin") {
            state.attendees = state.attendees.map((a) => (a.id === id ? { ...a, checkedIn: !a.checkedIn } : a));
          }
          if (action === "remove-attendee") {
            state.attendees = state.attendees.filter((a) => a.id !== id);
          }
          saveState(state);
          renderRoster(state, schedule);
        });
      }

      const exportRosterBtn = document.getElementById("exportRosterBtn");
      if (exportRosterBtn) {
        exportRosterBtn.addEventListener("click", () => exportRoster(state, schedule));
      }

      const clearRosterBtn = document.getElementById("clearRosterBtn");
      if (clearRosterBtn) {
        clearRosterBtn.addEventListener("click", () => {
          if (!window.confirm("Clear all saved RSVP/check-in and reserve request data on this device?")) return;
          state.attendees = [];
          state.reserveRequests = [];
          saveState(state);
          renderRoster(state, schedule);
          renderReserveQueue(state);
        });
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Myrtle Beach 2026 Golf Trip Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0d1726;
      --panel: #0f2138;
      --panel-soft: #132a45;
      --accent: #e0b457;
      --accent-2: #6dd3ff;
      --ink: #e6edf7;
      --ink-soft: #9fb6d4;
      --muted: #6b82a3;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 20px 50px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(109,211,255,0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(224,180,87,0.10), transparent 30%),
                  #0b1422;
      margin: 0;
      color: var(--ink);
      min-height: 100vh;
    }
    .container {
      max-width: 1100px;
      margin: 18px auto 32px;
      padding: 0 16px;
    }
    header.hero {
      background: linear-gradient(135deg, #0f2138 0%, #0b1626 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 16px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    h1 {
      margin: 0;
      font-size: clamp(1.4rem, 4vw, 2rem);
      display: flex;
      align-items: baseline;
      gap: 10px;
      letter-spacing: 0.4px;
    }
    h1 span {
      color: var(--accent);
      font-size: 0.9rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--ink-soft);
      font-size: 0.85rem;
    }
    .panel {
      background: linear-gradient(145deg, var(--panel) 0%, #0c1a2c 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 16px;
    }
    .summary-card {
      display: grid;
      gap: 12px;
      color: var(--ink);
      line-height: 1.6;
    }
    .summary-card strong { color: #fff; }
    a.cta {
      color: var(--accent-2);
      text-decoration: none;
      font-weight: 600;
    }
    a.cta:hover { text-decoration: underline; }
    .waze-link {
      color: var(--accent-2);
      font-weight: 700;
      text-decoration: none;
    }
    .waze-link:hover { text-decoration: underline; }
    .itinerary-list {
      display: grid;
      gap: 8px;
      margin: 8px 0 0;
      padding: 0;
      list-style: none;
    }
    .itinerary-item {
      background: var(--panel-soft);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 4px;
    }
    .itinerary-item small { color: var(--muted); }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .status-pill {
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--ink);
      font-size: 0.9rem;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
  }
  #condoGroups.cards-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 10px;
  }
  .condo-group {
    background: var(--panel-soft);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px;
    display: grid;
    gap: 10px;
  }
  .participant-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    display: grid;
    gap: 8px;
    font-size: 0.95rem;
  }
  .participant-card input,
  .participant-card select {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: #0b1728;
    color: var(--ink);
    font-size: 0.95rem;
  }
  .actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 8px;
  }
  #condoGroups .actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
  }
  #condoGroups .actions button,
  #condoGroups .actions select {
    padding: 8px 10px;
    font-size: 0.9rem;
  }
  .fields-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    align-items: center;
  }
  .stacked {
    display: grid;
    gap: 4px;
    color: var(--ink-soft);
    font-size: 0.9rem;
  }
  button {
    background: var(--accent);
    color: #0b1626;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 30px rgba(224,180,87,0.2);
    }
    button:hover { transform: translateY(-1px); }
    button.secondary {
      background: transparent;
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    #unassignedSidebar {
      background: linear-gradient(180deg, var(--panel) 0%, #0c192c 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 12px;
    }
    #unassignedSidebar ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 10px;
    }
    #unassignedSidebar li {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    #unassignedSidebar select,
    #unassignedSidebar button {
      width: 100%;
    }
    #summaryBox {
      background: var(--panel-soft);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      line-height: 1.6;
    }
    .status-labels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    .status-labels span {
      color: var(--ink-soft);
      font-size: 0.9rem;
    }
    /* Mobile-first adjustments */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      header.hero { position: static; }
      .actions { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px) {
      .container { padding: 0 12px; }
      .cards-grid { grid-template-columns: 1fr; }
      .actions { grid-template-columns: 1fr; }
      #allParticipantsList ol { padding-left: 20px; }
    }
  </style>
</head>
<body>
  <a href="/" style="position:fixed;top:12px;left:12px;padding:8px 12px;background:#0c1a2c;color:#f9fafb;text-decoration:none;border-radius:10px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.35);z-index:999;">‚Üê Main Page</a>
  <div class="container">
    <header class="hero">
      <h1>Myrtle Beach 2026 Golf Trip <span>Group 3/18-3/22/26</span></h1>
      <div class="chips">
        <div class="chip">Myrtle Beach, SC</div>
        <div class="chip">4 Nights / 5 Rounds</div>
        <div class="chip">Reservation #12972589</div>
      </div>
    </header>

    <div class="panel summary-card" id="summaryTop" style="display:grid;gap:12px;">
      <div id="tripSummary"></div>
      <div id="summaryBox" class="panel" style="margin:0;background:linear-gradient(145deg, var(--panel) 0%, #0c1a2c 100%);border:1px solid var(--border);border-radius:12px;padding:12px;line-height:1.5;"></div>
    </div>
    <div class="panel" id="itineraryBox" style="margin-bottom:12px;"></div>
    <div class="layout">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <h2 style="margin:0;font-size:1.1rem;letter-spacing:0.3px;">Accommodations</h2>
          <button id="addParticipantBtn" style="padding:10px 14px;font-weight:700;">Add Golfer</button>
        </div>
        <div id="condoGroups" class="cards-grid" style="margin-top:12px;"></div>
      </div>
      <div id="unassignedSidebar"></div>
    </div>
  </div>
  <a href="https://founders.teetimecentralonline.com/golfcentral/guests/login.aspx?user=tommy.knight@gmail.com&pwd=3/18/2026" target="_blank" aria-label="Admin login" style="position:fixed;left:12px;bottom:12px;padding:8px 12px;border-radius:10px;background:#0c1a2c;color:#f9fafb;text-decoration:none;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.35);">ADMIN</a>
  <script>
    const STATUS_ORDER = ['in', 'out', 'maybe', 'waitlist', 'invited'];
    const STATUS_LABELS = { invited: 'Invited', in: 'In', maybe: 'Maybe', out: 'Out', waitlist: 'Waitlist' };
    const BASE_GROUP_SIZES = [4, 8, 12, 16, 20, 24];
    const MYRTLE_ARRIVAL_DATE = '2026-03-18';
    const MYRTLE_DEPARTURE_DATE = '2026-03-22';
    const DEFAULT_TRIP = {
      name: 'tommy knight Group - Barefoot',
      location: 'Myrtle Beach, SC',
      arrivalDate: MYRTLE_ARRIVAL_DATE,
      departureDate: MYRTLE_DEPARTURE_DATE,
      package: '4 Nights / 5 Rounds',
      groupSize: 24,
      preparedBy: 'Myrtle Beach Golf Trips',
      phone: '(877) 283-2122',
      reservationNumber: '12972589',
      accommodations: {
        resort: 'Barefoot Golf Villas',
        unitType: '2 Bedroom Golf Course',
        units: 6,
        confirmations: '90612 90613 90615 90614 90611',
        arrivalDate: MYRTLE_ARRIVAL_DATE,
        departureDate: MYRTLE_DEPARTURE_DATE
      }
    };
    const DEFAULT_ROUNDS = [
      { course: 'World Tour Golf Links', address: '2000 World Tour Blvd, Myrtle Beach, SC 29579', date: '2026-03-18', time: '13:17' },
      { course: 'Wild Wing Avocet', address: '1000 Wild Wing Blvd, Conway, SC 29526', date: '2026-03-19', time: '09:09' },
      { course: "MB National Kings North", address: '4900 National Dr, Myrtle Beach, SC 29579', date: '2026-03-20', time: '08:26' },
      { course: 'River Hills', address: '3670 Cedar Creek Run, Little River, SC 29566', date: '2026-03-21', time: '09:15' },
      { course: 'Long Bay', address: '350 Fox Tail Dr, Longs, SC 29568', date: '2026-03-22', time: '08:00' }
    ];

    let tripId = null;
    let trip = null;
    let participants = [];

    const $ = (sel) => document.querySelector(sel);
    const formatDate = (d) => (d ? new Date(d).toLocaleDateString() : '');
    const tripApi = (path) => (path.includes('?') ? `${path}&myrtleBeach2026=true` : `${path}?myrtleBeach2026=true`);
    const safeNumber = (val) => (val === '' || isNaN(val) ? 0 : parseFloat(val));
    const getCondoCount = () => {
      const size = Number(trip?.baseGroupSize) || Number(trip?.groupSize) || DEFAULT_TRIP.groupSize;
      return Math.max(1, Math.ceil(size / 4));
    };
    const getCondoNumber = (assignment) => {
      const match = assignment && assignment.match(/^Condo (\d+) - Room ([AB])$/);
      const condoNum = match ? parseInt(match[1], 10) : null;
      return Number.isFinite(condoNum) ? condoNum : null;
    };
    const buildWazeLink = (course, address) => {
      const query = address || course;
      if (!query) return '';
      // Use Waze deep link that works on mobile (opens app) and desktop (opens web map)
      return `https://ul.waze.com/ul?q=${encodeURIComponent(query)}&navigate=yes`;
    };

    let adminCode = null;
    function getAdminCode() {
      if (adminCode) return adminCode;
      const code = prompt('Enter admin code:');
      if (!code) {
        alert('Admin code is required for this action.');
        return null;
      }
      adminCode = code;
      return adminCode;
    }

    async function updateParticipant(id, body, opts = {}) {
      const needsAdmin = opts.requireAdmin === true;
      const headers = { 'Content-Type': 'application/json' };
      if (needsAdmin) {
        const code = getAdminCode();
        if (!code) return;
        headers['x-admin-code'] = code;
      }
      await fetch(tripApi(`/api/trips/${tripId}/participants/${id}`), {
        method: 'PUT',
        headers,
        body: JSON.stringify(body)
      });
      await loadTrip();
    }

    async function loadTrip() {
      const res = await fetch(tripApi('/api/trips'));
      const trips = await res.json();
      trip = trips.find((t) => t.name && t.name.includes('Myrtle Beach'));
      if (!trip) return alert('Trip not found');
      tripId = trip._id;
      window.tripId = trip._id;
      const pRes = await fetch(tripApi(`/api/trips/${trip._id}/participants`));
      participants = await pRes.json();
      renderAll();
    }

    function renderAll() {
      renderTripSummary();
      renderItinerary();
      renderParticipants();
      renderSummary();
    }

    function renderTripSummary() {
      const t = trip || DEFAULT_TRIP;
      const accom = t.accommodations || DEFAULT_TRIP.accommodations;
      const arrivalDateDisplay = formatDate(MYRTLE_ARRIVAL_DATE) || '3/18/2026';
      const departureDateDisplay = formatDate(MYRTLE_DEPARTURE_DATE) || '3/22/2026';
      const summary = `
        <div style="display:grid;gap:6px;">
          <div><strong>Trip Name:</strong> ${t.name || 'Myrtle Beach - Barefoot Group 3/18-3/22/26'}</div>
          <div><strong>Location:</strong> ${t.location || 'Myrtle Beach, SC'}</div>
          <div><strong>Arrival:</strong> ${arrivalDateDisplay} &nbsp;|&nbsp; <strong>Departure:</strong> ${departureDateDisplay}</div>
          <div><strong>Package:</strong> ${t.package || '4 Nights / 5 Rounds'}</div>
          <div><strong>Group Size:</strong> ${t.groupSize || 24}</div>
          <div><strong>Reservation #:</strong> ${t.reservationNumber || '12972589'} &nbsp;|&nbsp; ${t.preparedBy || 'Myrtle Beach Golf Trips'} (${t.phone || '(877) 283-2122'})</div>
          <div><strong>Accommodations:</strong> ${accom?.resort || 'Barefoot Golf Villas'} | ${accom?.unitType || '2 Bedroom Golf Course'} | Units: ${accom?.units || 6} | Conf: ${accom?.confirmations || ''} | ${arrivalDateDisplay} -> ${departureDateDisplay}</div>
          <div><strong>Price:</strong> ${t.price || '$792.56 per person incl. lodging, 5 rounds, all taxes/fees (no breakfast).'}</div>
          <div style="display:grid;gap:8px;margin-top:8px;">
            <a class="cta" href="https://founders.teetimecentralonline.com/golfcentral/guests/Register.aspx?g=8ad2d184-cdb8-4b90-8dc6-55c68c26efe9&ResNum=12972589&arr=3/18/2026" target="_blank">Join Package (Register)</a>
          </div>
        </div>
      `;
      $('#tripSummary').innerHTML = summary;
    }

    function renderItinerary() {
      $('#itineraryBox').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <h2 style="margin:0;font-size:1.05rem;">Golf Schedule</h2>
          <div class="status-labels" id="statusSummaryRow"></div>
        </div>
        <ul class="itinerary-list" id="itineraryList"></ul>
        <div id="allParticipantsList" style="margin-top:12px;"></div>
      `;

      const rounds = Array.isArray(trip?.rounds) && trip.rounds.length ? trip.rounds : DEFAULT_ROUNDS;
      const list = $('#itineraryList');
      if (rounds.length) {
        list.innerHTML = rounds.map((r) => {
          const label = r.course || 'TBD';
          const link = buildWazeLink(r.course, r.address);
          const courseMarkup = link ? `<a class="waze-link" href="${link}" target="_blank" rel="noopener">${label}</a>` : label;
          const timeAddress = [r.time || '', r.address || ''].filter(Boolean).join(' | ');
          return `
            <li class="itinerary-item">
              <strong>${formatDate(r.date)} | ${courseMarkup}</strong>
              ${timeAddress ? `<small>${timeAddress}</small>` : ''}
              ${r.confirmation ? `<small>Conf #${r.confirmation}</small>` : ''}
            </li>
          `;
        }).join('');
      } else {
        list.innerHTML = `<li class="itinerary-item">Rounds not entered yet.</li>`;
      }

      renderStatusList();

      const inCount = participants.filter((p) => p.status === 'in').length;
      const nextIncrement = Math.ceil(Math.max(inCount, 1) / 4) * 4;
      const needed = Math.max(nextIncrement - inCount, 0);
      const statusRow = $('#statusSummaryRow');
      if (statusRow) {
        statusRow.innerHTML = `
          <div class="status-box" style="display:grid;gap:6px;background:var(--panel-soft);border:1px solid var(--border);border-radius:12px;padding:12px;">
            <strong>Confirmed Golfers: <span style="color:var(--accent);">${inCount}</span></strong>
            <span style="color:var(--muted);font-size:0.95rem;">
              ${needed > 0
                ? `Need ${needed} more to reach the next full group of 4.`
                : `We have a full group of ${inCount}. Next target: ${nextIncrement + 4}.`}
            </span>
          </div>
        `;
      }
    }

    function renderStatusList() {
      if (!Array.isArray(participants) || !participants.length) {
        $('#allParticipantsList').innerHTML = '';
        return;
      }
      const counts = { in: 0, out: 0, maybe: 0, waitlist: 0, invited: 0 };
      participants.forEach((p) => { if (counts.hasOwnProperty(p.status)) counts[p.status]++; });

      const sorted = [...participants].sort((a, b) => {
        const sa = STATUS_ORDER.indexOf(a.status);
        const sb = STATUS_ORDER.indexOf(b.status);
        if (sa !== sb) return sa - sb;
        return (a.name || '').localeCompare(b.name || '');
      });
      const perCol = Math.ceil(sorted.length / 2);
      const cols = [sorted.slice(0, perCol), sorted.slice(perCol)];

      let tableHtml = `
        <div class="status-grid">
          ${STATUS_ORDER.map((s) => `<div class="status-pill"><span>${STATUS_LABELS[s]}</span><strong>${counts[s]}</strong></div>`).join('')}
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;">
      `;
      for (let colIdx = 0; colIdx < cols.length; colIdx++) {
        const col = cols[colIdx];
        const start = colIdx * perCol + 1;
        tableHtml += `<ol start='${start}' style='margin:0;padding-left:18px;display:grid;gap:6px;'>${col.map((p) =>
          `<li style="margin:0;display:grid;gap:6px;">
            <div style="font-weight:600;color:#fff;">${p.name}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
              <select class='golfer-status-dropdown' data-id='${p._id}' style='font-size:13px;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0b1728;color:var(--ink);'>
                ${STATUS_ORDER.map((opt) => `<option value='${opt}'${p.status === opt ? ' selected' : ''}>${STATUS_LABELS[opt]}</option>`).join('')}
              </select>
              <input type='number' class='golfer-paid-input' data-id='${p._id}' value='${(p.totalPaidAmount || 0).toFixed(2)}' min='0' step='0.01' style='padding:8px;border-radius:8px;border:1px solid var(--border);background:#0b1728;color:var(--ink);' placeholder='Paid'>
            </div>
          </li>`
        ).join('')}</ol>`;
      }
      tableHtml += `</div>`;
      $('#allParticipantsList').innerHTML = tableHtml;

      document.querySelectorAll('.golfer-status-dropdown').forEach((sel) => {
        sel.addEventListener('change', async function () {
          await updateParticipant(this.dataset.id, { status: this.value }, { requireAdmin: true });
        });
      });
      document.querySelectorAll('.golfer-paid-input').forEach((input) => {
        input.addEventListener('change', async function () {
          await updateParticipant(this.dataset.id, { totalPaidAmount: safeNumber(this.value) }, { requireAdmin: true });
        });
      });
    }

    function renderBaseGroupSizeSelect() {
      const select = $('#baseGroupSizeSelect');
      if (!select) return;
      select.innerHTML = '';
      BASE_GROUP_SIZES.forEach((n) => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = `${n} players`;
        if (trip?.baseGroupSize == n) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function renderParticipants() {
      const container = document.getElementById('condoGroups');
      if (!container) return;
      container.innerHTML = '';

      const condoCount = getCondoCount();
      const condoCounts = Array(condoCount).fill(0);
      participants.forEach((g) => {
        const condoNum = getCondoNumber(g.roomAssignment);
        if (!condoNum) return;
        const idx = condoNum - 1;
        if (idx >= 0 && idx < condoCount) condoCounts[idx]++;
      });

      for (let i = 0; i < condoCount; i++) {
        const div = document.createElement('div');
        div.className = 'condo-group';
        div.innerHTML = `<strong>Condo ${i + 1}</strong><div class="cards-grid"></div>`;
        const grid = div.querySelector('.cards-grid');
        const group = participants.filter((p) => {
          return getCondoNumber(p.roomAssignment) === i + 1;
        });
        for (const p of group) {
          const match = p.roomAssignment && p.roomAssignment.match(/^Condo (\d+) - Room ([AB])$/);
          const room = match ? match[2] : '';
          const currentCondo = getCondoNumber(p.roomAssignment);
          let moveOptions = `<option value="unassigned">Unassigned</option>`;
          for (let c = 1; c <= condoCount; c++) {
            if (c !== currentCondo && condoCounts[c - 1] < 4) moveOptions += `<option value="${c}">Condo ${c}</option>`;
          }
          const card = document.createElement('div');
          card.className = 'participant-card';
          card.innerHTML = `
            <div class="fields-row">
              <label class="stacked"><span>Name</span><input type="text" value="${p.name || ''}" data-id="${p._id}" class="name-input"></label>
              <label class="stacked"><span>Room</span><select class="room-select" data-id="${p._id}">
                <option value="A"${room === 'A' ? ' selected' : ''}>A</option>
                <option value="B"${room === 'B' ? ' selected' : ''}>B</option>
              </select></label>
              <label class="stacked"><span>Extra Night</span><input type="checkbox" ${p.wantsExtraNight ? 'checked' : ''} class="extra-night-input" data-id="${p._id}"></label>
            </div>
            <div class="actions">
              <button class="remove-condo-btn" data-id="${p._id}">Unassign</button>
              ${moveOptions ? `<select class="move-condo-select" data-id="${p._id}" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1728;color:var(--ink);"><option value="">Move to...</option>${moveOptions}</select>` : ''}
            </div>
          `;
          grid.appendChild(card);
        }
        container.appendChild(div);
      }

      const unassigned = participants.filter((p) => {
        const condoNum = getCondoNumber(p.roomAssignment);
        return !condoNum || condoNum < 1 || condoNum > condoCount;
      });
      const unassignedSidebar = document.getElementById('unassignedSidebar');
      if (unassignedSidebar) {
        unassignedSidebar.innerHTML = `
          <div style="display:grid;gap:8px;">
            <div>
              <label style="color:var(--ink-soft);font-size:0.9rem;">Base Group Size</label>
              <select name="baseGroupSize" id="baseGroupSizeSelect" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1728;color:var(--ink);"></select>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <strong>Unassigned</strong>
              <span style="color:var(--muted);font-size:0.9rem;">${unassigned.length}</span>
            </div>
            <div style="max-height:420px;overflow-y:auto;">
              <ul id="unassignedList"></ul>
            </div>
          </div>
        `;
        renderBaseGroupSizeSelect();
      }

      const ul = document.getElementById('unassignedList');
      if (!ul || !unassignedSidebar) return;
      ul.innerHTML = '';
      if (!unassigned.length) {
        ul.innerHTML = `<li style="color:var(--muted);">Everyone is assigned.</li>`;
      } else {
        const condoOptions = Array.from({ length: condoCount }, (_, idx) => `<option value="${idx + 1}">Condo ${idx + 1}</option>`).join('');
        unassigned.forEach((p) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="margin-bottom:6px;font-weight:600;">${p.name}</div>
            <select class="assign-condo-select" data-id="${p._id}">
              <option value="">Assign to condo...</option>
              ${condoOptions}
            </select>
            <button class="remove-golfer-btn" data-id="${p._id}" style="margin-top:8px;background:#c93636;color:#fff;">Delete</button>
          `;
          ul.appendChild(li);
        });
      }

      if (unassignedSidebar._changeHandler) unassignedSidebar.removeEventListener('change', unassignedSidebar._changeHandler);
      unassignedSidebar._changeHandler = async function (e) {
        if (e.target.classList.contains('assign-condo-select')) {
          const condoNum = Number(e.target.value);
          const id = e.target.dataset.id;
          if (!condoNum || condoNum < 1 || condoNum > condoCount) return;
          await updateParticipant(id, { roomAssignment: `Condo ${condoNum} - Room A` }, { requireAdmin: true });
        }
        if (e.target.id === 'baseGroupSizeSelect') {
          await fetch(tripApi(`/api/trips/${tripId}`), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ baseGroupSize: Number(e.target.value) || undefined })
          });
          await loadTrip();
        }
      };
      unassignedSidebar.addEventListener('change', unassignedSidebar._changeHandler);

      if (unassignedSidebar._removeHandler) unassignedSidebar.removeEventListener('click', unassignedSidebar._removeHandler);
      unassignedSidebar._removeHandler = async function (e) {
        if (e.target.classList.contains('remove-golfer-btn')) {
          const code = getAdminCode();
          if (!code) return;
          const id = e.target.dataset.id;
          if (!confirm('Remove this golfer from the event?')) return;
          await fetch(tripApi(`/api/trips/${tripId}/participants/${id}`), {
            method: 'DELETE',
            headers: { 'x-admin-code': code }
          });
          await loadTrip();
        }
      };
      unassignedSidebar.addEventListener('click', unassignedSidebar._removeHandler);
    }

    function renderSummary() {
      const total = participants.length;
      const counts = { in: 0, maybe: 0, out: 0, waitlist: 0, invited: 0 };
      let depositTotal = 0;
      let extraNightCount = 0;
      participants.forEach((p) => {
        const status = counts.hasOwnProperty(p.status) ? p.status : 'invited';
        counts[status] = (counts[status] || 0) + 1;
        depositTotal += Number(p.totalPaidAmount || p.depositPaidAmount || 0);
        if (p.wantsExtraNight) extraNightCount++;
      });
      const extraNightCost = 33;
      const extraNightTotal = extraNightCount * extraNightCost;
      const summaryEl = $('#summaryBox');
      if (!summaryEl) return;
      summaryEl.innerHTML = `
        <div style="display:grid;gap:4px;color:var(--ink);">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong>Live Summary</strong>
            <span style="color:var(--muted);font-size:0.9rem;">Updated</span>
          </div>
          <div>Total participants: ${total}</div>
          <div>In: ${counts.in} | Maybe: ${counts.maybe} | Out: ${counts.out} | Waitlist: ${counts.waitlist} | Invited: ${counts.invited}</div>
          <div>Total deposits received: $${depositTotal.toFixed(2)}</div>
          <div>Wants extra night: ${extraNightCount} x $${extraNightCost} = <strong>$${extraNightTotal}</strong></div>
        </div>
      `;
    }

    const condoGroups = document.getElementById('condoGroups');
    if (condoGroups) {
      condoGroups.addEventListener('click', async function (e) {
        if (e.target.classList.contains('move-condo-select')) {
          const id = e.target.dataset.id;
          const val = e.target.value;
          if (!val) return;
          const condoCount = getCondoCount();
          if (val === 'unassigned') {
            await updateParticipant(id, { roomAssignment: null }, { requireAdmin: true });
          } else if (Number(val) >= 1 && Number(val) <= condoCount) {
            await updateParticipant(id, { roomAssignment: `Condo ${val} - Room A` }, { requireAdmin: true });
          }
        }
        if (e.target.classList.contains('remove-condo-btn')) {
          const id = e.target.dataset.id;
          await updateParticipant(id, { roomAssignment: null }, { requireAdmin: true });
        }
      });
      condoGroups.addEventListener('change', async function (e) {
        if (e.target.classList.contains('room-select')) {
          const id = e.target.dataset.id;
          const room = e.target.value;
          const match = participants.find((p) => p._id === id)?.roomAssignment?.match(/^Condo (\d+) - Room ([AB])$/);
          const condoNum = match ? match[1] : null;
          if (condoNum) {
            await updateParticipant(id, { roomAssignment: `Condo ${condoNum} - Room ${room}` }, { requireAdmin: true });
          }
        }
        if (e.target.classList.contains('name-input')) {
          const id = e.target.dataset.id;
          await updateParticipant(id, { name: e.target.value });
        }
        if (e.target.classList.contains('extra-night-input')) {
          const id = e.target.dataset.id;
          await updateParticipant(id, { wantsExtraNight: e.target.checked });
        }
      });
    }

    const addBtn = document.getElementById('addParticipantBtn');
    if (addBtn) {
      addBtn.onclick = async function () {
        const name = prompt('Golfer name:');
        if (!name) return;
        await fetch(tripApi(`/api/trips/${tripId}/participants`), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, status: 'invited' })
        });
        await loadTrip();
      };
    }

    window.addEventListener('DOMContentLoaded', loadTrip);
  </script>
</body>
</html>
